<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Batch Subtitle Tools</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loading-overlay" class="overlay">
        <div class="spinner"></div>
        <p>Processing files...</p>
    </div>

    <main>
        <section class="tool-card">
            <h2>Batch SRT to VTT Converter</h2>
            <p class="instructions">Select one or more **.srt** files. You will be asked to choose a destination folder.</p>
            
            <form id="converter-form" class="upload-form">
                <input type="file" id="srt-input" accept=".srt" multiple required>
                <button type="submit">Convert & Save All</button>
            </form>
            <div id="converter-message" class="result-message"></div>
        </section>

        <hr>

        <section class="tool-card">
            <h2>Batch VTT Timing Shifter (+6s)</h2>
            <p class="instructions">Select one or more **.vtt** files. You will be asked to choose a destination folder.</p>
            
            <form id="shifter-form" class="upload-form">
                <input type="file" id="vtt-input" accept=".vtt" multiple required>
                <button type="submit">Shift & Save All</button>
            </form>
            <div id="shifter-message" class="result-message"></div>
        </section>
    </main>

    <script>
        const overlay = document.getElementById('loading-overlay');

        async function saveFilesToDirectory(filesToSave) {
            try {
                if (!window.showDirectoryPicker) {
                    alert("Your browser does not support choosing save folders. Please use a recent version of Chrome or Edge.");
                    return false;
                }
                const directoryHandle = await window.showDirectoryPicker();
                overlay.style.display = 'flex'; // Show spinner after folder is picked
                
                for (const item of filesToSave) {
                    const fileHandle = await directoryHandle.getFileHandle(item.name, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(item.content);
                    await writable.close();
                }
                return true;
            } catch (err) {
                if (err.name === 'AbortError') return false; 
                alert("An error occurred: " + err.message);
                return false;
            } finally {
                overlay.style.display = 'none'; // Hide spinner
            }
        }

        function srtToVtt(srtContent) {
            let vttContent = "WEBVTT\n\n";
            const blocks = srtContent.trim().split(/\r?\n\r?\n/);
            blocks.forEach(block => {
                const lines = block.trim().split(/\r?\n/);
                if (lines.length > 1 && lines[1].includes('-->')) {
                    let timing = lines[1].replace(/,/g, '.');
                    const text = lines.slice(2).join('\n');
                    vttContent += `${timing}\n${text}\n\n`;
                }
            });
            return vttContent.trim();
        }

        const SIX_SECONDS_MS = 6000;
        function timeToMs(timeStr) {
            const [h, m, sMs] = timeStr.split(':').map(s => s.trim());
            const [s, ms] = sMs.split('.');
            return ((parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s)) * 1000 + parseInt(ms));
        }
        function msToTime(totalMs) {
            if (totalMs < 0) totalMs = 0;
            const ms = totalMs % 1000;
            let totalSeconds = Math.floor(totalMs / 1000);
            const s = totalSeconds % 60;
            totalSeconds = Math.floor(totalSeconds / 60);
            const m = totalSeconds % 60;
            const h = Math.floor(totalSeconds / 60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
        }

        function shiftVtt(vttContent) {
            const lines = vttContent.split(/\r?\n/);
            return lines.map(line => {
                if (line.includes('-->')) {
                    const parts = line.split(' ');
                    const startMs = timeToMs(parts[0]);
                    const endMs = timeToMs(parts[2]);
                    const metadata = parts.slice(3).join(' ');
                    return `${msToTime(startMs + SIX_SECONDS_MS)} --> ${msToTime(endMs + SIX_SECONDS_MS)} ${metadata}`.trim();
                }
                return line;
            }).join('\n');
        }

        document.getElementById('converter-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const files = document.getElementById('srt-input').files;
            const messageDiv = document.getElementById('converter-message');
            const processedFiles = [];
            
            for (let file of files) {
                const text = await file.text();
                processedFiles.push({
                    name: file.name.replace(/\.[^/.]+$/, "") + ".vtt",
                    content: srtToVtt(text)
                });
            }

            if (await saveFilesToDirectory(processedFiles)) {
                messageDiv.textContent = `Successfully converted and saved ${processedFiles.length} files.`;
                messageDiv.style.display = 'block';
            }
        });

        document.getElementById('shifter-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const files = document.getElementById('vtt-input').files;
            const messageDiv = document.getElementById('shifter-message');
            const processedFiles = [];

            for (let file of files) {
                const text = await file.text();
                processedFiles.push({
                    name: file.name.replace(/\.[^/.]+$/, "") + "_shifted.vtt",
                    content: shiftVtt(text)
                });
            }

            if (await saveFilesToDirectory(processedFiles)) {
                messageDiv.textContent = `Successfully shifted and saved ${processedFiles.length} files.`;
                messageDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>
