<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Batch Subtitle Tools</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loading-overlay" class="overlay">
        <div class="spinner"></div>
        <p>Processing files...</p>
    </div>

    <main>
        <section class="tool-card">
            <h2>Batch SRT to VTT converter</h2>
            <p class="instructions">Select one or more **.srt** files. You will be asked to choose a destination folder.</p>
            
            <form id="converter-form" class="upload-form">
                <input type="file" id="srt-input" accept=".srt" multiple required>
                <button type="submit">Convert & save all</button>
            </form>
            <div id="converter-message" class="result-message"></div>
        </section>

        <hr>

        <section class="tool-card">
            <h2>Batch VTT caption timing shifter (+6s)</h2>
            <p class="instructions">Select one or more **.vtt** files. You will be asked to choose a destination folder.</p>
            
            <form id="shifter-form" class="upload-form">
                <input type="file" id="vtt-input" accept=".vtt" multiple required>
                <button type="submit">Shift & save all</button>
            </form>
            <div id="shifter-message" class="result-message"></div>
        </section>
    </main>

    <script>
const overlay = document.getElementById('loading-overlay');

/**
 * processBatch handles the final execution when "Save All" is clicked.
 */
async function processBatch(fileInputId, type) {
    const fileInput = document.getElementById(fileInputId);
    const files = fileInput.files;

    // Check if files were actually selected first
    if (files.length === 0) {
        alert("Please select or drop files first.");
        return;
    }

    // Step 2 & 3: Open the Directory Picker (Save location)
    let directoryHandle;
    try {
        if (!window.showDirectoryPicker) {
            alert("Your browser does not support folder saving. Please use Chrome or Edge.");
            return;
        }
        directoryHandle = await window.showDirectoryPicker();
    } catch (err) {
        // User cancelled the folder picker
        console.log("Folder selection cancelled.");
        return;
    }

    // Step 5: Immediately after folder is picked and "Save All" logic continues, show spinner
    overlay.style.display = 'flex';

    try {
        // Step 6: Loop through files, convert/shift, and write
        for (let file of files) {
            const text = await file.text();
            let finalContent = "";
            let finalName = "";

            if (type === 'convert') {
                finalContent = srtToVtt(text);
                finalName = file.name.replace(/\.[^/.]+$/, "") + ".vtt";
            } else {
                finalContent = shiftVtt(text);
                finalName = file.name.replace(/\.[^/.]+$/, "") + "_shifted.vtt";
            }

            // Write the file to the chosen folder
            const fileHandle = await directoryHandle.getFileHandle(finalName, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(finalContent);
            await writable.close();
        }

        // Step 7: Success!
        const msgId = type === 'convert' ? 'converter-message' : 'shifter-message';
        const messageDiv = document.getElementById(msgId);
        messageDiv.textContent = `Success! ${files.length} files saved to your folder.`;
        messageDiv.style.display = 'block';
        messageDiv.style.color = "#009ABC"; // UC Blue
        messageDiv.style.fontWeight = "700";

    } catch (err) {
        alert("Processing error: " + err.message);
    } finally {
        // Step 7: Hide Spinner
        overlay.style.display = 'none';
    }
}

// --- Conversion Logic Functions ---

function srtToVtt(srtContent) {
    let vttContent = "WEBVTT\n\n";
    const blocks = srtContent.trim().split(/\r?\n\r?\n/);
    blocks.forEach(block => {
        const lines = block.trim().split(/\r?\n/);
        if (lines.length > 1 && lines[1].includes('-->')) {
            let timing = lines[1].replace(/,/g, '.');
            const text = lines.slice(2).join('\n');
            vttContent += `${timing}\n${text}\n\n`;
        }
    });
    return vttContent.trim();
}

const SIX_SECONDS_MS = 6000;
function timeToMs(timeStr) {
    const [h, m, sMs] = timeStr.split(':').map(s => s.trim());
    const [s, ms] = sMs.split('.');
    return ((parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s)) * 1000 + parseInt(ms));
}

function msToTime(totalMs) {
    if (totalMs < 0) totalMs = 0;
    const ms = totalMs % 1000;
    let totalSeconds = Math.floor(totalMs / 1000);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds / 60) % 60;
    const h = Math.floor(totalSeconds / 3600);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
}

function shiftVtt(vttContent) {
    const lines = vttContent.split(/\r?\n/);
    return lines.map(line => {
        if (line.includes('-->')) {
            const parts = line.split(' ');
            const startMs = timeToMs(parts[0]);
            const endMs = timeToMs(parts[2]);
            const metadata = parts.slice(3).join(' ');
            return `${msToTime(startMs + SIX_SECONDS_MS)} --> ${msToTime(endMs + SIX_SECONDS_MS)} ${metadata}`.trim();
        }
        return line;
    }).join('\n');
}

// --- Event Listeners ---

document.getElementById('converter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    processBatch('srt-input', 'convert');
});

document.getElementById('shifter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    processBatch('vtt-input', 'shift');
});
    </script>
</body>
</html>
